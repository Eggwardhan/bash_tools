#!/bin/bash

# CodeX & ClaudeCode ä¸€é”®å®‰è£…è„šæœ¬ for Linux (ä¸­å›½é•œåƒä¼˜åŒ–ç‰ˆ)
set -e  # é‡åˆ°é”™è¯¯ç«‹å³é€€å‡º

echo "å¼€å§‹å®‰è£… CodeX å’Œ ClaudeCode..."
echo "ä½¿ç”¨ä¸­å›½é•œåƒæºä¼˜åŒ–ä¸‹è½½é€Ÿåº¦..."

# é…ç½®ä¸­å›½é•œåƒæº
setup_china_mirrors() {
    # é…ç½® npm æ·˜å®é•œåƒ
    npm config set registry https://registry.npmmirror.com    
    echo "âœ“ npm é•œåƒå·²é…ç½®ä¸ºæ·˜å®é•œåƒ"
}

# å®‰è£…æœ€æ–°ç‰ˆ Node.js
install_latest_node() {
    echo "æ­£åœ¨å®‰è£…æœ€æ–°ç‰ˆ Node.js..."
    
    # æ¸…ç†å¯èƒ½çš„æ—§ç‰ˆæœ¬
    sudo apt-get remove -y nodejs npm
    sudo apt-get autoremove -y
    
    # å®‰è£… curl å’Œå¿…è¦çš„å·¥å…·
    sudo apt-get update
    sudo apt-get install -y curl git build-essential
    
    # ä½¿ç”¨ NodeSource å®‰è£…æœ€æ–° LTS ç‰ˆæœ¬
    curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
    sudo apt-get install -y nodejs
    
    # éªŒè¯å®‰è£…
    NODE_VERSION=$(node -v)
    NPM_VERSION=$(npm -v)
    echo "âœ“ Node.js $NODE_VERSION å®‰è£…å®Œæˆ"
    echo "âœ“ npm $NPM_VERSION å®‰è£…å®Œæˆ"
}

# å®‰è£… CodeX
install_codex() {
    echo "å¼€å§‹å®‰è£… CodeX..."
    
    # ä½¿ç”¨æ·˜å®é•œåƒå®‰è£… CodeX CLI
    npm install -g @openai/codex --registry=https://registry.npmmirror.com
    
    # åˆ›å»ºé…ç½®ç›®å½•
    CONFIG_DIR="$HOME/.codex"
    mkdir -p "$CONFIG_DIR"
    # åˆ›å»º config.toml é…ç½®æ–‡ä»¶
    CONFIG_FILE="$CONFIG_DIR/config.toml"
    cat > "$CONFIG_FILE" << EOF
disable_response_storage = true
model_provider ="crs"
model="gpt-5-codex"
model_reasoning_effort = "high"
preferred_auth_method ="apikey"
[model_providers.crs]
name = "crs"
base_url="https://claude.doffe.cn/openai"
wire_api ="responses"
requires_openai_auth = true
env_key ="OPENAI_API_KEY"
EOF
    echo "âœ“ CodeX å®‰è£…å®Œæˆ"
}
# å®‰è£… Google Gemini CLI å·¥å…·
install_gemini() {
    echo "å¼€å§‹å®‰è£… Google Gemini ç›¸å…³å·¥å…·..."

    # å®‰è£… Google å®˜æ–¹çš„ Gemini CLI å·¥å…·
    if npm view @google/gemini-cli 2>/dev/null; then
        echo "å®‰è£… Google å®˜æ–¹ Gemini CLI å·¥å…·..."
        npm install -g @google/gemini-cli --registry=https://registry.npmmirror.com
        echo "âœ“ @google/gemini-cli å®‰è£…å®Œæˆ"
    else
        echo "âš ï¸  @google/gemini-cli åŒ…æœªæ‰¾åˆ°"
    fi

    # å®‰è£… Google Generative AI SDK
    if npm view @google/generative-ai 2>/dev/null; then
        echo "å®‰è£… Google Generative AI npm åŒ…..."
        npm install -g @google/generative-ai --registry=https://registry.npmmirror.com
        echo "âœ“ @google/generative-ai å®‰è£…å®Œæˆ"
    else
        echo "âš ï¸  @google/generative-ai åŒ…æœªæ‰¾åˆ°"
    fi

    # åŒæ—¶å®‰è£… Python SDKï¼ˆå¯é€‰ï¼Œä½†æ¨èï¼‰
    echo "æ£€æŸ¥å¹¶å®‰è£… Python ç›¸å…³åŒ…..."
    if command -v pip &> /dev/null; then
        pip install google-generativeai --index-url https://pypi.tuna.tsinghua.edu.cn/simple
        echo "âœ“ google-generativeai Python åŒ…å®‰è£…å®Œæˆ"
    elif command -v uv &> /dev/null; then
        uv pip install google-generativeai --index-url https://pypi.tuna.tsinghua.edu.cn/simple
        echo "âœ“ google-generativeai Python åŒ…å®‰è£…å®Œæˆ"
    fi

    echo "âœ“ Google Gemini ç›¸å…³å·¥å…·å®‰è£…å®Œæˆ"
}

# é…ç½®ç¯å¢ƒå˜é‡
setup_environment_variables() {
    local bashrc_file="$HOME/.bashrc"
    local env_marker="# AI Tools Environment Variables"

    echo "é…ç½®ç¯å¢ƒå˜é‡åˆ° $bashrc_file ..."

    # æ£€æŸ¥æ˜¯å¦å·²ç»é…ç½®è¿‡
    if grep -q "$env_marker" "$bashrc_file" 2>/dev/null; then
        echo "âœ“ ç¯å¢ƒå˜é‡å·²å­˜åœ¨ï¼Œè·³è¿‡é…ç½®"
        return
    fi

    # æ·»åŠ ç¯å¢ƒå˜é‡é…ç½®
    cat >> "$bashrc_file" << EOF

$env_marker
# OpenAI CodeX é…ç½®
export OPENAI_API_KEY=""
export OPENAI_BASE_URL="https://claude.doffe.cn/openai"
# Anthropic ClaudeCode é…ç½®
export ANTHROPIC_API_KEY=""
export ANTHROPIC_BASE_URL="http://106.15.7.100:5000"
# Google Gemini é…ç½®
export GOOGLE_API_KEY=""

EOF

    echo "âœ“ ç¯å¢ƒå˜é‡å·²æ·»åŠ åˆ° $bashrc_file"
    echo "âš ï¸  è¯·è®°å¾—ç¼–è¾‘ $bashrc_file å¹¶å¡«å…¥çœŸå®çš„ API Keys"
}


# é…ç½® ClaudeCode å®Œæˆå¼•å¯¼çŠ¶æ€
configure_claude_onboarding() {
    echo "é…ç½® ClaudeCode å¼•å¯¼çŠ¶æ€..."

    CLAUDE_CONFIG="$HOME/.claude.json"

    # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if [ -f "$CLAUDE_CONFIG" ]; then
        # ä½¿ç”¨ jq æ·»åŠ æˆ–æ›´æ–° hasCompletedOnboarding å­—æ®µ
        if command -v jq &> /dev/null; then
            # ä½¿ç”¨ jq ä¿®æ”¹
            jq '. + {"hasCompletedOnboarding": true}' "$CLAUDE_CONFIG" > "$CLAUDE_CONFIG.tmp"
            mv "$CLAUDE_CONFIG.tmp" "$CLAUDE_CONFIG"
            echo "âœ“ ä½¿ç”¨ jq æ›´æ–° ~/.claude.json"
        else
            # ä½¿ç”¨ Node.js ä¿®æ”¹
            node -e "
                const fs = require('fs');
                const config = JSON.parse(fs.readFileSync('$CLAUDE_CONFIG', 'utf8'));
                config.hasCompletedOnboarding = true;
                fs.writeFileSync('$CLAUDE_CONFIG', JSON.stringify(config, null, 2));
            "
            echo "âœ“ ä½¿ç”¨ Node.js æ›´æ–° ~/.claude.json"
        fi
    else
        # åˆ›å»ºæ–°æ–‡ä»¶
        cat > "$CLAUDE_CONFIG" << EOF
{
  "hasCompletedOnboarding": true
}
EOF
        echo "âœ“ ~/.claude.json å·²åˆ›å»ºå¹¶é…ç½®"
    fi
}

# å®‰è£… ClaudeCode
install_claudecode() {
    echo "å¼€å§‹å®‰è£… ClaudeCode..."

    # ä½¿ç”¨æ·˜å®é•œåƒå®‰è£… ClaudeCode
    # æ³¨æ„ï¼šClaudeCode å¯èƒ½æœ‰ä¸åŒçš„åŒ…åï¼Œè¿™é‡Œå‡è®¾æ˜¯ @anthropic-ai/claudecode
    # å¦‚æœåŒ…åä¸å¯¹ï¼Œè¯·æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´
    npm install -g @anthropic-ai/claude-code

    # é…ç½®å¼•å¯¼çŠ¶æ€
    configure_claude_onboarding

    echo "âœ“ ClaudeCode å®‰è£…å®Œæˆ"
}

# å®‰è£… pnpm (å¯é€‰ï¼Œä½†æ¨èç”¨äºæ›´å¥½çš„åŒ…ç®¡ç†)
install_pnpm() {
    echo "å®‰è£… pnpm (å¿«é€ŸåŒ…ç®¡ç†å™¨)..."
    npm install -g pnpm --registry=https://registry.npmmirror.com
    pnpm config set registry https://registry.npmmirror.com
    echo "âœ“ pnpm å®‰è£…å®Œæˆ"
}

# ä¸»å®‰è£…æµç¨‹
main() {
    echo "========================================"
    echo "CodeX & ClaudeCode ä¸€é”®å®‰è£…è„šæœ¬"
    echo "ä¼˜åŒ–ä¸­å›½ç”¨æˆ·ä½¿ç”¨ä½“éªŒ"
    echo "========================================"
    
    # é…ç½®é•œåƒæº
    
    # æ£€æŸ¥ Node.js
    if command -v node &> /dev/null; then
        CURRENT_NODE_VERSION=$(node -v)
        echo "å½“å‰ Node.js ç‰ˆæœ¬: $CURRENT_NODE_VERSION"
        read -p "æ˜¯å¦é‡æ–°å®‰è£…æœ€æ–°ç‰ˆ Node.js? (y/N): " reinstall_node
        if [[ $reinstall_node =~ ^[Yy]$ ]]; then
            install_latest_node
        else
            echo "ä½¿ç”¨ç°æœ‰ Node.js ç‰ˆæœ¬"
        fi
    else
        install_latest_node
    fi
    setup_china_mirrors
    # å®‰è£… pnpm
    install_pnpm

    # å®‰è£… CodeX
    install_codex

    # å®‰è£… ClaudeCode
    install_claudecode

    # å®‰è£… Google Gemini
    install_gemini

    setup_environment_variables
    # æ˜¾ç¤ºå®‰è£…æ€»ç»“
    echo ""
    echo "========================================"
    echo "ğŸ‰ å®‰è£…å®Œæˆï¼"
    echo "========================================"
}

# è¿è¡Œä¸»å‡½æ•°
main "$@"

