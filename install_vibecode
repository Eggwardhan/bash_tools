#!/bin/bash

# CodeX & ClaudeCode ä¸€é”®å®‰è£…è„šæœ¬ for Linux & macOS (ä¸­å›½é•œåƒä¼˜åŒ–ç‰ˆ)
# æ³¨æ„ï¼šæ¯ä¸ªå‡½æ•°å³ä½¿å¤±è´¥ä¹Ÿä¼šç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤

echo "å¼€å§‹å®‰è£… CodeX å’Œ ClaudeCode..."
echo "ä½¿ç”¨ä¸­å›½é•œåƒæºä¼˜åŒ–ä¸‹è½½é€Ÿåº¦..."

# æ£€æµ‹æ“ä½œç³»ç»Ÿç±»å‹
detect_os() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        OS_TYPE="macos"
        echo "æ£€æµ‹åˆ°æ“ä½œç³»ç»Ÿ: macOS"
    elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
        OS_TYPE="linux"
        echo "æ£€æµ‹åˆ°æ“ä½œç³»ç»Ÿ: Linux"
    else
        echo "é”™è¯¯: ä¸æ”¯æŒçš„æ“ä½œç³»ç»Ÿ ($OSTYPE)"
        exit 1
    fi
}

# é…ç½®ä¸­å›½é•œåƒæº
setup_china_mirrors() {
    # é…ç½® npm æ·˜å®é•œåƒ
    npm config set registry https://registry.npmmirror.com    
    echo "âœ“ npm é•œåƒå·²é…ç½®ä¸ºæ·˜å®é•œåƒ"
}

# å®‰è£…æœ€æ–°ç‰ˆ Node.js
install_latest_node() {
    echo "æ­£åœ¨å®‰è£…æœ€æ–°ç‰ˆ Node.js..."

    if [ "$OS_TYPE" == "linux" ]; then
        # æ¸…ç†å¯èƒ½çš„æ—§ç‰ˆæœ¬
        sudo apt-get remove -y nodejs npm
        sudo apt-get autoremove -y

        # å®‰è£… curl å’Œå¿…è¦çš„å·¥å…·
        sudo apt-get update
        sudo apt-get install -y curl git build-essential

        # ä½¿ç”¨ NodeSource å®‰è£…æœ€æ–° LTS ç‰ˆæœ¬
        curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
        sudo apt-get install -y nodejs
    elif [ "$OS_TYPE" == "macos" ]; then
        # æ£€æŸ¥ Homebrew æ˜¯å¦å®‰è£…
        if ! command -v brew &> /dev/null; then
            echo "æ­£åœ¨å®‰è£… Homebrew..."
            /bin/bash -c "$(curl -fsSL https://gitee.com/ineo6/homebrew-install/raw/master/install.sh)"
            # é…ç½® Homebrew ç¯å¢ƒå˜é‡
            echo 'eval "$(/opt/homebrew/bin/brew shellenv)"' >> ~/.zshrc
            eval "$(/opt/homebrew/bin/brew shellenv)"
        fi

        # Homebrew ä¼šè‡ªåŠ¨å¤„ç† Node.js çš„å‡çº§å’Œæ›¿æ¢ï¼Œæ— éœ€æ‰‹åŠ¨å¸è½½æ—§ç‰ˆæœ¬
        echo "ä½¿ç”¨ Homebrew å®‰è£…/å‡çº§ Node.js..."
        brew update
        brew install node
    fi

    # éªŒè¯å®‰è£…
    NODE_VERSION=$(node -v)
    NPM_VERSION=$(npm -v)
    echo "âœ“ Node.js $NODE_VERSION å®‰è£…å®Œæˆ"
    echo "âœ“ npm $NPM_VERSION å®‰è£…å®Œæˆ"
}

# å®‰è£… CodeX
install_codex() {
    echo "å¼€å§‹å®‰è£… CodeX..."
    
    # ä½¿ç”¨æ·˜å®é•œåƒå®‰è£… CodeX CLI
    if npm install -g @openai/codex --registry=https://registry.npmmirror.com 2>/dev/null; then
        echo "âœ“ CodeX CLI å®‰è£…æˆåŠŸ"
    else
        echo "âš ï¸  CodeX CLI å·²å­˜åœ¨æˆ–å®‰è£…å¤±è´¥ï¼Œç»§ç»­é…ç½®..."
    fi

    # åˆ›å»ºé…ç½®ç›®å½•
    CONFIG_DIR="$HOME/.codex"
    mkdir -p "$CONFIG_DIR"

    # åˆ›å»º config.toml é…ç½®æ–‡ä»¶
    CONFIG_FILE="$CONFIG_DIR/config.toml"
    cat > "$CONFIG_FILE" <<'EOF'
ask_for_approval = "never"
sandbox = "workspace-write"
skip_git_repo_check = true
disable_response_storage = true
model_provider = "crs"
model = "gpt-5.2"
model_reasoning_effort = "xhigh"
preferred_auth_method = "apikey"

[model_providers.crs]
name = "crs"
base_url = "https://claude.doffe.cn/openai"
wire_api = "responses"
requires_openai_auth = true
env_key = "OPENAI_API_KEY"
EOF
    echo "âœ“ config.toml å·²åˆ›å»º"

    # æç¤ºç”¨æˆ·è¾“å…¥ API Key
    echo ""
    echo "è¯·è¾“å…¥ OPENAI_API_KEY:"
    read -r OPENAI_KEY

    # åˆ›å»º auth.json é…ç½®æ–‡ä»¶
    AUTH_FILE="$CONFIG_DIR/auth.json"
    cat > "$AUTH_FILE" <<EOF
{
  "OPENAI_API_KEY": "$OPENAI_KEY"
}
EOF
    echo "âœ“ auth.json å·²åˆ›å»º"
    echo "âœ“ CodeX å®‰è£…å®Œæˆ"
}
# å®‰è£… Google Gemini CLI å·¥å…·
install_gemini() {
    echo "å¼€å§‹å®‰è£… Google Gemini ç›¸å…³å·¥å…·..."

    # å®‰è£… Google å®˜æ–¹çš„ Gemini CLI å·¥å…·
    if npm view @google/gemini-cli 2>/dev/null; then
        echo "å®‰è£… Google å®˜æ–¹ Gemini CLI å·¥å…·..."
        if npm install -g @google/gemini-cli --registry=https://registry.npmmirror.com 2>/dev/null; then
            echo "âœ“ @google/gemini-cli å®‰è£…å®Œæˆ"
        else
            echo "âš ï¸  @google/gemini-cli å®‰è£…å¤±è´¥ï¼Œç»§ç»­..."
        fi
    else
        echo "âš ï¸  @google/gemini-cli åŒ…æœªæ‰¾åˆ°"
    fi

    # å®‰è£… Google Generative AI SDK
    if npm view @google/generative-ai 2>/dev/null; then
        echo "å®‰è£… Google Generative AI npm åŒ…..."
        if npm install -g @google/generative-ai --registry=https://registry.npmmirror.com 2>/dev/null; then
            echo "âœ“ @google/generative-ai å®‰è£…å®Œæˆ"
        else
            echo "âš ï¸  @google/generative-ai å®‰è£…å¤±è´¥ï¼Œç»§ç»­..."
        fi
    else
        echo "âš ï¸  @google/generative-ai åŒ…æœªæ‰¾åˆ°"
    fi

    # åŒæ—¶å®‰è£… Python SDKï¼ˆå¯é€‰ï¼Œä½†æ¨èï¼‰
    echo "æ£€æŸ¥å¹¶å®‰è£… Python ç›¸å…³åŒ…..."
    if command -v pip &> /dev/null; then
        if pip install google-generativeai --index-url https://pypi.tuna.tsinghua.edu.cn/simple 2>/dev/null; then
            echo "âœ“ google-generativeai Python åŒ…å®‰è£…å®Œæˆ"
        else
            echo "âš ï¸  google-generativeai Python åŒ…å®‰è£…å¤±è´¥ï¼Œç»§ç»­..."
        fi
    elif command -v uv &> /dev/null; then
        if uv pip install google-generativeai --index-url https://pypi.tuna.tsinghua.edu.cn/simple 2>/dev/null; then
            echo "âœ“ google-generativeai Python åŒ…å®‰è£…å®Œæˆ"
        else
            echo "âš ï¸  google-generativeai Python åŒ…å®‰è£…å¤±è´¥ï¼Œç»§ç»­..."
        fi
    fi

    echo "âœ“ Google Gemini ç›¸å…³å·¥å…·å®‰è£…å®Œæˆ"
}

# é…ç½®ç¯å¢ƒå˜é‡
setup_environment_variables() {
    # æ ¹æ®æ“ä½œç³»ç»Ÿç¡®å®šé…ç½®æ–‡ä»¶
    if [ "$OS_TYPE" == "linux" ]; then
        local config_file="$HOME/.bashrc"
    elif [ "$OS_TYPE" == "macos" ]; then
        # macOS ä¼˜å…ˆä½¿ç”¨ .zshrc (é»˜è®¤ Shell)ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™æ£€æŸ¥ .bash_profile
        if [ -f "$HOME/.zshrc" ]; then
            local config_file="$HOME/.zshrc"
        elif [ -f "$HOME/.bash_profile" ]; then
            local config_file="$HOME/.bash_profile"
        else
            local config_file="$HOME/.bashrc"  # å¤‡ç”¨
        fi
    fi

    local env_marker="# AI Tools Environment Variables"

    echo "é…ç½®ç¯å¢ƒå˜é‡åˆ° $config_file ..."

    # æ£€æŸ¥æ˜¯å¦å·²ç»é…ç½®è¿‡
    if grep -q "$env_marker" "$config_file" 2>/dev/null; then
        echo "âœ“ ç¯å¢ƒå˜é‡å·²å­˜åœ¨ï¼Œè·³è¿‡é…ç½®"
        return
    fi

    # æ·»åŠ ç¯å¢ƒå˜é‡é…ç½®
    cat >> "$config_file" << EOF

$env_marker
# OpenAI CodeX é…ç½®
export OPENAI_API_KEY=""
export OPENAI_BASE_URL="https://claude.doffe.cn/openai"
# Anthropic ClaudeCode é…ç½®
export ANTHROPIC_BASE_URL="https://claude.doffe.cn/api"
export ANTHROPIC_AUTH_TOKEN="cr_c024c04500b6e134f818dd57e92a61e61cf32adb0c8e72b77abfeebc45c4be63"
# Google Gemini é…ç½®
export GOOGLE_API_KEY=""

EOF

    echo "âœ“ ç¯å¢ƒå˜é‡å·²æ·»åŠ åˆ° $config_file"
    echo "âš ï¸  è¯·è®°å¾—ç¼–è¾‘ $config_file å¹¶å¡«å…¥çœŸå®çš„ API Keys"
}


# é…ç½® ClaudeCode å®Œæˆå¼•å¯¼çŠ¶æ€
configure_claude_onboarding() {
    echo "é…ç½® ClaudeCode å¼•å¯¼çŠ¶æ€..."

    CLAUDE_CONFIG="$HOME/.claude.json"

    # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if [ -f "$CLAUDE_CONFIG" ]; then
        # ä½¿ç”¨ jq æ·»åŠ æˆ–æ›´æ–° hasCompletedOnboarding å­—æ®µ
        if command -v jq &> /dev/null; then
            # ä½¿ç”¨ jq ä¿®æ”¹
            jq '. + {"hasCompletedOnboarding": true}' "$CLAUDE_CONFIG" > "$CLAUDE_CONFIG.tmp"
            mv "$CLAUDE_CONFIG.tmp" "$CLAUDE_CONFIG"
            echo "âœ“ ä½¿ç”¨ jq æ›´æ–° ~/.claude.json"
        else
            # ä½¿ç”¨ Node.js ä¿®æ”¹
            node -e "
                const fs = require('fs');
                const config = JSON.parse(fs.readFileSync('$CLAUDE_CONFIG', 'utf8'));
                config.hasCompletedOnboarding = true;
                fs.writeFileSync('$CLAUDE_CONFIG', JSON.stringify(config, null, 2));
            "
            echo "âœ“ ä½¿ç”¨ Node.js æ›´æ–° ~/.claude.json"
        fi
    else
        # åˆ›å»ºæ–°æ–‡ä»¶
        cat > "$CLAUDE_CONFIG" << EOF
{
  "hasCompletedOnboarding": true
}
EOF
        echo "âœ“ ~/.claude.json å·²åˆ›å»ºå¹¶é…ç½®"
    fi
}

# å®‰è£… ClaudeCode
install_claudecode() {
    echo "å¼€å§‹å®‰è£… ClaudeCode..."

    # ä½¿ç”¨æ·˜å®é•œåƒå®‰è£… ClaudeCode
    # æ³¨æ„ï¼šClaudeCode å¯èƒ½æœ‰ä¸åŒçš„åŒ…åï¼Œè¿™é‡Œå‡è®¾æ˜¯ @anthropic-ai/claudecode
    # å¦‚æœåŒ…åä¸å¯¹ï¼Œè¯·æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´
    if npm install -g @anthropic-ai/claude-code 2>/dev/null; then
        echo "âœ“ ClaudeCode CLI å®‰è£…æˆåŠŸ"
    else
        echo "âš ï¸  ClaudeCode CLI å·²å­˜åœ¨æˆ–å®‰è£…å¤±è´¥ï¼Œç»§ç»­é…ç½®..."
    fi

    # é…ç½®å¼•å¯¼çŠ¶æ€
    configure_claude_onboarding

    echo "âœ“ ClaudeCode å®‰è£…å®Œæˆ"
}

# å®‰è£… pnpm (å¯é€‰ï¼Œä½†æ¨èç”¨äºæ›´å¥½çš„åŒ…ç®¡ç†)
install_pnpm() {
    echo "å®‰è£… pnpm (å¿«é€ŸåŒ…ç®¡ç†å™¨)..."
    if npm install -g pnpm --registry=https://registry.npmmirror.com 2>/dev/null; then
        pnpm config set registry https://registry.npmmirror.com 2>/dev/null || true
        echo "âœ“ pnpm å®‰è£…å®Œæˆ"
    else
        echo "âš ï¸  pnpm å·²å­˜åœ¨æˆ–å®‰è£…å¤±è´¥ï¼Œç»§ç»­..."
    fi
}

# ä¸»å®‰è£…æµç¨‹
main() {
    echo "========================================"
    echo "CodeX & ClaudeCode ä¸€é”®å®‰è£…è„šæœ¬"
    echo "ä¼˜åŒ–ä¸­å›½ç”¨æˆ·ä½¿ç”¨ä½“éªŒ"
    echo "========================================"

    # æ£€æµ‹æ“ä½œç³»ç»Ÿ
    detect_os

    # é…ç½®é•œåƒæº

    # æ£€æŸ¥ Node.js
    if command -v node &> /dev/null; then
        CURRENT_NODE_VERSION=$(node -v)
        echo "å½“å‰ Node.js ç‰ˆæœ¬: $CURRENT_NODE_VERSION"
        read -p "æ˜¯å¦é‡æ–°å®‰è£…æœ€æ–°ç‰ˆ Node.js? (y/N): " reinstall_node
        if [[ $reinstall_node =~ ^[Yy]$ ]]; then
            install_latest_node
        else
            echo "ä½¿ç”¨ç°æœ‰ Node.js ç‰ˆæœ¬"
        fi
    else
        install_latest_node
    fi
    setup_china_mirrors
    # å®‰è£… pnpm
    install_pnpm

    # å®‰è£… CodeX
    install_codex

    # å®‰è£… ClaudeCode
    install_claudecode

    # å®‰è£… Google Gemini
    install_gemini

    setup_environment_variables
    # æ˜¾ç¤ºå®‰è£…æ€»ç»“
    echo ""
    echo "========================================"
    echo "ğŸ‰ å®‰è£…å®Œæˆï¼"
    echo "========================================"
}

# è¿è¡Œä¸»å‡½æ•°
main "$@"

